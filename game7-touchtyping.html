<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×§×œ×“×” ×¢×™×•×•×¨×ª - ××××Ÿ ×”×§×œ×“×”</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .lang-selector {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 2000;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .lang-btn {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid transparent;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            color: #667eea;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .lang-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            color: #667eea;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 20px;
            font-weight: bold;
            z-index: 2000;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 1200px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-top: 5px;
        }

        .lesson-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .lesson-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            font-weight: bold;
        }

        .lesson-btn:hover {
            background: #667eea;
            color: white;
        }

        .lesson-btn.active {
            background: #667eea;
            color: white;
        }

        .typing-area {
            margin-bottom: 30px;
        }

        .text-to-type {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 20px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 5px;
            font-weight: bold;
        }

        .text-to-type .char {
            display: inline-block;
            padding: 0 3px;
        }

        .text-to-type .char.correct {
            color: #28a745;
        }

        .text-to-type .char.incorrect {
            color: #dc3545;
            background: #ffe0e0;
        }

        .text-to-type .char.current {
            background: #ffd700;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .input-area {
            text-align: center;
            margin-bottom: 20px;
        }

        #typingInput {
            width: 80%;
            padding: 15px;
            font-size: 2em;
            text-align: center;
            border: 3px solid #667eea;
            border-radius: 10px;
            direction: rtl;
        }

        #typingInput:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .keyboard {
            background: #2c3e50;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
            gap: 5px;
        }

        .key {
            background: linear-gradient(180deg, #ecf0f1 0%, #bdc3c7 100%);
            border: 2px solid #34495e;
            border-radius: 5px;
            padding: 15px;
            min-width: 50px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 3px 0 #34495e;
        }

        .key:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #34495e;
        }

        .key.highlight {
            background: linear-gradient(180deg, #ffd700 0%, #ffed4e 100%);
            animation: keyPulse 0.5s infinite;
            border-color: #f39c12;
        }

        .key.pressed {
            background: linear-gradient(180deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-color: #2c3e50;
        }

        .key.home-row {
            background: linear-gradient(180deg, #a8dadc 0%, #81b3b6 100%);
        }

        .key.space {
            min-width: 300px;
        }

        @keyframes keyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .hand-position {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
        }

        .hand-position h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .hands {
            display: flex;
            justify-content: center;
            gap: 50px;
            flex-wrap: wrap;
        }

        .hand {
            font-size: 1.2em;
        }

        .finger {
            display: inline-block;
            margin: 0 5px;
        }

        .finger.active {
            color: #ff6b6b;
            font-weight: bold;
            transform: scale(1.3);
            display: inline-block;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .message {
            text-align: center;
            margin-top: 20px;
            font-size: 1.5em;
            font-weight: bold;
            min-height: 30px;
        }

        .message.success {
            color: #28a745;
        }

        .message.error {
            color: #dc3545;
        }

        .instructions {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 5px solid #ffc107;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .instructions p {
            color: #856404;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .key {
                min-width: 35px;
                padding: 10px 5px;
                font-size: 1em;
            }

            .key.space {
                min-width: 200px;
            }

            .text-to-type {
                font-size: 1.5em;
            }

            #typingInput {
                width: 95%;
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="lang-selector">
        <button class="lang-btn active" data-lang="he" onclick="setLanguage('he')">ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª</button>
        <button class="lang-btn" data-lang="en" onclick="setLanguage('en')">ğŸ‡¬ğŸ‡§ English</button>
        <button class="lang-btn" data-lang="fr" onclick="setLanguage('fr')">ğŸ‡«ğŸ‡· FranÃ§ais</button>
    </div>
    <a href="index.html" class="back-btn">
        <span class="lang-he" data-i18n="common.back">â† ×—×–×¨×”</span>
        <span class="lang-en" data-i18n="common.back">â† Back</span>
        <span class="lang-fr" data-i18n="common.back">â† Retour</span>
    </a>
    
    <div class="container">
        <h1>
            <span class="lang-he" data-i18n="touchtyping.title">ğŸ¯ ××××Ÿ ×”×§×œ×“×” ×¢×™×•×•×¨×ª</span>
            <span class="lang-en" data-i18n="touchtyping.title">ğŸ¯ Touch Typing Trainer</span>
            <span class="lang-fr" data-i18n="touchtyping.title">ğŸ¯ EntraÃ®neur de frappe au toucher</span>
        </h1>

        <div class="instructions">
            <h3>
                <span class="lang-he" data-i18n="touchtyping.instructions">ğŸ“š ×”×•×¨××•×ª:</span>
                <span class="lang-en" data-i18n="touchtyping.instructions">ğŸ“š Instructions:</span>
                <span class="lang-fr" data-i18n="touchtyping.instructions">ğŸ“š Instructions :</span>
            </h3>
            <p class="lang-he" data-i18n="touchtyping.instructionText">
                ×œ××“ ×œ×”×§×œ×™×“ ×œ×œ× ×”×¡×ª×›×œ×•×ª ×¢×œ ×”××§×œ×“×ª! ×”×ª×—×œ ××©×•×¨×ª ×”×‘×™×ª (××©×“×’×›×¢×™×—×œ×š×£) ×•×”×ª×§×“× ×œ×¨××•×ª ×§×©×•×ª ×™×•×ª×¨.
                ×©×™× ××ª ×”××¦×‘×¢×•×ª ×¢×œ ×©×•×¨×ª ×”×‘×™×ª ×•×¢×§×•×‘ ××—×¨ ×”××•×ª ×”××•×“×’×©×ª ×¢×œ ×”××§×œ×“×ª.
            </p>
            <p class="lang-en" data-i18n="touchtyping.instructionText">
                Learn to type without looking at the keyboard! Start with the home row (××©×“×’×›×¢×™×—×œ×š×£) and progress to harder levels.
                Place your fingers on the home row and follow the highlighted letter on the keyboard.
            </p>
            <p class="lang-fr" data-i18n="touchtyping.instructionText">
                Apprenez Ã  taper sans regarder le clavier ! Commencez par la rangÃ©e de base (××©×“×’×›×¢×™×—×œ×š×£) et progressez vers des niveaux plus difficiles.
                Placez vos doigts sur la rangÃ©e de base et suivez la lettre en surbrillance sur le clavier.
            </p>
        </div>

        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">
                    <span class="lang-he" data-i18n="touchtyping.speed">××”×™×¨×•×ª (×ª×•×•×™×/×“×§×”)</span>
                    <span class="lang-en" data-i18n="touchtyping.speed">Speed (chars/min)</span>
                    <span class="lang-fr" data-i18n="touchtyping.speed">Vitesse (car/min)</span>
                </div>
                <div class="stat-value" id="wpm">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">
                    <span class="lang-he" data-i18n="touchtyping.accuracy">×“×™×•×§</span>
                    <span class="lang-en" data-i18n="touchtyping.accuracy">Accuracy</span>
                    <span class="lang-fr" data-i18n="touchtyping.accuracy">PrÃ©cision</span>
                </div>
                <div class="stat-value" id="accuracy">100%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">
                    <span class="lang-he" data-i18n="touchtyping.errors">×˜×¢×•×™×•×ª</span>
                    <span class="lang-en" data-i18n="touchtyping.errors">Errors</span>
                    <span class="lang-fr" data-i18n="touchtyping.errors">Erreurs</span>
                </div>
                <div class="stat-value" id="errors">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">
                    <span class="lang-he" data-i18n="touchtyping.progress">×”×ª×§×“××•×ª</span>
                    <span class="lang-en" data-i18n="touchtyping.progress">Progress</span>
                    <span class="lang-fr" data-i18n="touchtyping.progress">ProgrÃ¨s</span>
                </div>
                <div class="stat-value" id="progress">0/0</div>
            </div>
        </div>

        <div class="lesson-selector">
            <button class="lesson-btn active" data-level="1">
                <span class="lang-he" data-i18n="touchtyping.homeRow">×©×•×¨×ª ×‘×™×ª</span>
                <span class="lang-en" data-i18n="touchtyping.homeRow">Home Row</span>
                <span class="lang-fr" data-i18n="touchtyping.homeRow">RangÃ©e de base</span>
            </button>
            <button class="lesson-btn" data-level="2">
                <span class="lang-he" data-i18n="touchtyping.topRow">×©×•×¨×” ×¢×œ×™×•× ×”</span>
                <span class="lang-en" data-i18n="touchtyping.topRow">Top Row</span>
                <span class="lang-fr" data-i18n="touchtyping.topRow">RangÃ©e supÃ©rieure</span>
            </button>
            <button class="lesson-btn" data-level="3">
                <span class="lang-he" data-i18n="touchtyping.bottomRow">×©×•×¨×” ×ª×—×ª×•× ×”</span>
                <span class="lang-en" data-i18n="touchtyping.bottomRow">Bottom Row</span>
                <span class="lang-fr" data-i18n="touchtyping.bottomRow">RangÃ©e infÃ©rieure</span>
            </button>
            <button class="lesson-btn" data-level="4">
                <span class="lang-he" data-i18n="touchtyping.allLetters">×›×œ ×”××•×ª×™×•×ª</span>
                <span class="lang-en" data-i18n="touchtyping.allLetters">All Letters</span>
                <span class="lang-fr" data-i18n="touchtyping.allLetters">Toutes les lettres</span>
            </button>
            <button class="lesson-btn" data-level="5">
                <span class="lang-he" data-i18n="touchtyping.words">××™×œ×™×</span>
                <span class="lang-en" data-i18n="touchtyping.words">Words</span>
                <span class="lang-fr" data-i18n="touchtyping.words">Mots</span>
            </button>
            <button class="lesson-btn" data-level="6">
                <span class="lang-he" data-i18n="touchtyping.sentences">××©×¤×˜×™×</span>
                <span class="lang-en" data-i18n="touchtyping.sentences">Sentences</span>
                <span class="lang-fr" data-i18n="touchtyping.sentences">Phrases</span>
            </button>
        </div>

        <div class="hand-position">
            <h3>
                <span class="lang-he" data-i18n="touchtyping.handPosition">ğŸ‘ ××™×§×•× ×™×“×™×™×</span>
                <span class="lang-en" data-i18n="touchtyping.handPosition">ğŸ‘ Hand Position</span>
                <span class="lang-fr" data-i18n="touchtyping.handPosition">ğŸ‘ Position des mains</span>
            </h3>
            <div class="hands">
                <div class="hand">
                    <span class="lang-he" data-i18n="touchtyping.rightHand">×™×“ ×™××™×Ÿ: </span>
                    <span class="lang-en" data-i18n="touchtyping.rightHand">Right Hand: </span>
                    <span class="lang-fr" data-i18n="touchtyping.rightHand">Main droite : </span>
                    <span class="finger" id="right-pinky">×š</span>
                    <span class="finger" id="right-ring">×œ</span>
                    <span class="finger" id="right-middle">×—</span>
                    <span class="finger" id="right-index">×™/×¢</span>
                </div>
                <div class="hand">
                    <span class="lang-he" data-i18n="touchtyping.leftHand">×™×“ ×©×××œ: </span>
                    <span class="lang-en" data-i18n="touchtyping.leftHand">Left Hand: </span>
                    <span class="lang-fr" data-i18n="touchtyping.leftHand">Main gauche : </span>
                    <span class="finger" id="left-index">×›/×’</span>
                    <span class="finger" id="left-middle">×“</span>
                    <span class="finger" id="left-ring">×©</span>
                    <span class="finger" id="left-pinky">×/×¤/×£</span>
                </div>
            </div>
        </div>

        <div class="typing-area">
            <div class="text-to-type" id="textToType"></div>
            <div class="input-area">
                <input type="text" id="typingInput" placeholder="" autocomplete="off">
            </div>
        </div>

        <div class="keyboard">
            <div class="keyboard-row">
                <div class="key" data-key="=">=</div>
                <div class="key" data-key="-">-</div>
                <div class="key" data-key=")">)</div>
                <div class="key" data-key="(">(</div>
                <div class="key" data-key="*">*</div>
                <div class="key" data-key="&">&</div>
                <div class="key" data-key="^">^</div>
                <div class="key" data-key="%">%</div>
                <div class="key" data-key="$">$</div>
                <div class="key" data-key="#">#</div>
                <div class="key" data-key="@">@</div>
                <div class="key" data-key="!">!</div>
                <div class="key" data-key="~">~</div>
            </div>
            <div class="keyboard-row">
                <div class="key" data-key="\\">\</div>
                <div class="key" data-key="]">]</div>
                <div class="key" data-key="[">[</div>
                <div class="key" data-key="×¤">×¤</div>
                <div class="key" data-key="×">×</div>
                <div class="key" data-key="×Ÿ">×Ÿ</div>
                <div class="key" data-key="×•">×•</div>
                <div class="key" data-key="×˜">×˜</div>
                <div class="key" data-key="×">×</div>
                <div class="key" data-key="×¨">×¨</div>
                <div class="key" data-key="×§">×§</div>
                <div class="key" data-key="'">'</div>
                <div class="key" data-key="/">/</div>
            </div>
            <div class="keyboard-row">
                <div class="key" data-key=",">,</div>
                <div class="key home-row" data-key="×£">×£</div>
                <div class="key home-row" data-key="×š">×š</div>
                <div class="key home-row" data-key="×œ">×œ</div>
                <div class="key home-row" data-key="×—">×—</div>
                <div class="key home-row" data-key="×™">×™</div>
                <div class="key home-row" data-key="×¢">×¢</div>
                <div class="key home-row" data-key="×›">×›</div>
                <div class="key home-row" data-key="×’">×’</div>
                <div class="key home-row" data-key="×“">×“</div>
                <div class="key home-row" data-key="×©">×©</div>
            </div>
            <div class="keyboard-row">
                <div class="key" data-key=".">.</div>
                <div class="key" data-key="×¥">×¥</div>
                <div class="key" data-key="×ª">×ª</div>
                <div class="key" data-key="×¦">×¦</div>
                <div class="key" data-key="×">×</div>
                <div class="key" data-key="× ">× </div>
                <div class="key" data-key="×”">×”</div>
                <div class="key" data-key="×‘">×‘</div>
                <div class="key" data-key="×¡">×¡</div>
                <div class="key" data-key="×–">×–</div>
            </div>
            <div class="keyboard-row">
                <div class="key space" data-key=" ">×¨×•×•×—</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="startBtn">
                <span class="lang-he" data-i18n="touchtyping.startExercise">×”×ª×—×œ ×ª×¨×’×™×œ ×—×“×©</span>
                <span class="lang-en" data-i18n="touchtyping.startExercise">Start New Exercise</span>
                <span class="lang-fr" data-i18n="touchtyping.startExercise">Commencer un nouvel exercice</span>
            </button>
            <button class="btn btn-secondary" id="resetBtn">
                <span class="lang-he" data-i18n="touchtyping.resetStats">××¤×¡ ×¡×˜×˜×™×¡×˜×™×§×•×ª</span>
                <span class="lang-en" data-i18n="touchtyping.resetStats">Reset Statistics</span>
                <span class="lang-fr" data-i18n="touchtyping.resetStats">RÃ©initialiser les statistiques</span>
            </button>
        </div>

        <div class="message" id="message"></div>
    </div>

    <!-- Load localization FIRST -->
    <script src="localization.js"></script>
    
    <script>
        const lessons = {
            1: { // Home row
                name: '×©×•×¨×ª ×‘×™×ª',
                chars: ['×', '×©', '×“', '×’', '×›', '×¢', '×™', '×—', '×œ', '×š', '×£'],
                type: 'chars'
            },
            2: { // Top row
                name: '×©×•×¨×” ×¢×œ×™×•× ×”',
                chars: ['×§', '×¨', '×', '×˜', '×•', '×Ÿ', '×', '×¤'],
                type: 'chars'
            },
            3: { // Bottom row
                name: '×©×•×¨×” ×ª×—×ª×•× ×”',
                chars: ['×–', '×¡', '×‘', '×”', '× ', '×', '×¦', '×ª', '×¥'],
                type: 'chars'
            },
            4: { // All letters
                name: '×›×œ ×”××•×ª×™×•×ª',
                chars: ['×', '×‘', '×’', '×“', '×”', '×•', '×–', '×—', '×˜', '×™', '×›', '×š', '×œ', '×', '×', '× ', '×Ÿ', '×¡', '×¢', '×¤', '×£', '×¦', '×¥', '×§', '×¨', '×©', '×ª'],
                type: 'chars'
            },
            5: { // Words
                name: '××™×œ×™×',
                words: ['×©×œ×•×', '×™×œ×“', '×¡×¤×¨', '×‘×™×ª', '×™×•×', '×œ×™×œ×”', '×××', '××‘×', '×›×œ×‘', '×—×ª×•×œ', '×¢×¥', '×¤×¨×—', '××™×', '×œ×—×', '×©××©', '×™×¨×—', '×›×•×›×‘', '×™×', '×”×¨', '× ×”×¨'],
                type: 'words'
            },
            6: { // Sentences
                name: '××©×¤×˜×™×',
                sentences: [
                    '×©×œ×•× ×œ×›×•×œ×',
                    '××™×š ×”×•×œ×š ×”×™×•×',
                    '×× ×™ ××•×”×‘ ×œ×§×¨×•×',
                    '×”×©××© ×–×•×¨×—×ª ×‘×©××™×™×',
                    '×”×™×œ×“×™× ××©×—×§×™× ×‘×’×Ÿ',
                    '×× ×™ ×œ×•××“ ×¢×‘×¨×™×ª',
                    '×–×” ×™×•× ×™×¤×”',
                    '×× ×™ ××•×›×œ ××¨×•×—×ª ×‘×•×§×¨',
                    '×”×—×ª×•×œ ×™×©×Ÿ ×¢×œ ×”×¡×¤×”',
                    '×× ×™ ×”×•×œ×š ×œ×‘×™×ª ×”×¡×¤×¨'
                ],
                type: 'sentences'
            }
        };

        const fingerMap = {
            // Right hand
            '×š': 'right-pinky',
            '×£': 'right-pinky',
            '×œ': 'right-ring',
            '×—': 'right-middle',
            '×™': 'right-index',
            '×¢': 'right-index',
            '×•': 'right-index',
            '×Ÿ': 'right-ring',
            '×': 'right-pinky',
            '×¤': 'right-pinky',
            // Left hand
            '×›': 'left-index',
            '×’': 'left-index',
            '×“': 'left-middle',
            '×©': 'left-ring',
            '×': 'left-pinky',
            '×§': 'left-pinky',
            '×¨': 'left-ring',
            '×˜': 'left-index',
            '×–': 'left-pinky',
            '×¡': 'left-ring',
            '×‘': 'left-middle',
            '×”': 'left-index',
            '× ': 'left-index',
            '×': 'left-middle',
            '×¦': 'left-ring',
            '×ª': 'left-pinky',
            '×¥': 'left-pinky',
            ' ': 'both'
        };

        let currentLevel = 1;
        let currentText = '';
        let currentIndex = 0;
        let errors = 0;
        let totalChars = 0;
        let startTime = null;
        let isActive = false;

        const typingInput = document.getElementById('typingInput');
        const textToType = document.getElementById('textToType');
        const wpmEl = document.getElementById('wpm');
        const accuracyEl = document.getElementById('accuracy');
        const errorsEl = document.getElementById('errors');
        const progressEl = document.getElementById('progress');
        const messageEl = document.getElementById('message');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');

        // Lesson selection
        document.querySelectorAll('.lesson-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.lesson-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentLevel = parseInt(btn.dataset.level);
                startNewExercise();
            });
        });

        function generateText(level) {
            const lesson = lessons[level];
            let text = '';

            if (lesson.type === 'chars') {
                const length = 20;
                for (let i = 0; i < length; i++) {
                    text += lesson.chars[Math.floor(Math.random() * lesson.chars.length)];
                    if (i < length - 1 && Math.random() > 0.7) {
                        text += ' ';
                    }
                }
            } else if (lesson.type === 'words') {
                const count = 5;
                for (let i = 0; i < count; i++) {
                    text += lesson.words[Math.floor(Math.random() * lesson.words.length)];
                    if (i < count - 1) text += ' ';
                }
            } else if (lesson.type === 'sentences') {
                text = lesson.sentences[Math.floor(Math.random() * lesson.sentences.length)];
            }

            return text;
        }

        function displayText() {
            textToType.innerHTML = '';
            for (let i = 0; i < currentText.length; i++) {
                const span = document.createElement('span');
                span.className = 'char';
                span.textContent = currentText[i];
                if (i === currentIndex) {
                    span.classList.add('current');
                }
                textToType.appendChild(span);
            }
            highlightKey(currentText[currentIndex]);
            highlightFinger(currentText[currentIndex]);
        }

        function highlightKey(char) {
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('highlight');
            });
            if (char) {
                const key = document.querySelector(`.key[data-key="${char}"]`);
                if (key) {
                    key.classList.add('highlight');
                }
            }
        }

        function highlightFinger(char) {
            document.querySelectorAll('.finger').forEach(finger => {
                finger.classList.remove('active');
            });
            const fingerId = fingerMap[char];
            if (fingerId) {
                if (fingerId === 'both') {
                    document.getElementById('left-index').classList.add('active');
                    document.getElementById('right-index').classList.add('active');
                } else {
                    const finger = document.getElementById(fingerId);
                    if (finger) {
                        finger.classList.add('active');
                    }
                }
            }
        }

        function updateStats() {
            const elapsed = startTime ? (Date.now() - startTime) / 1000 / 60 : 0;
            const wpm = elapsed > 0 ? Math.round(totalChars / elapsed) : 0;
            const accuracy = totalChars > 0 ? Math.round(((totalChars - errors) / totalChars) * 100) : 100;

            wpmEl.textContent = wpm;
            accuracyEl.textContent = accuracy + '%';
            errorsEl.textContent = errors;
            progressEl.textContent = `${currentIndex}/${currentText.length}`;
        }

        function startNewExercise() {
            currentText = generateText(currentLevel);
            currentIndex = 0;
            isActive = true;
            startTime = null;
            typingInput.value = '';
            typingInput.disabled = false;
            typingInput.focus();
            displayText();
            updateStats();
            messageEl.textContent = '';
            messageEl.className = 'message';
        }

        function handleInput(e) {
            if (!isActive) return;

            if (!startTime) {
                startTime = Date.now();
            }

            const inputChar = e.data;
            const expectedChar = currentText[currentIndex];

            if (inputChar === expectedChar) {
                // Correct
                const charSpan = textToType.children[currentIndex];
                charSpan.classList.remove('current');
                charSpan.classList.add('correct');
                
                // Visual feedback
                const key = document.querySelector(`.key[data-key="${expectedChar}"]`);
                if (key) {
                    key.classList.add('pressed');
                    setTimeout(() => key.classList.remove('pressed'), 200);
                }

                currentIndex++;
                totalChars++;

                if (currentIndex >= currentText.length) {
                    // Exercise complete
                    isActive = false;
                    typingInput.disabled = true;
                    messageEl.textContent = 'ğŸ‰ ×›×œ ×”×›×‘×•×“! ×”×©×œ××ª ××ª ×”×ª×¨×’×™×œ!';
                    messageEl.className = 'message success';
                    highlightKey(null);
                    highlightFinger(null);
                } else {
                    displayText();
                }
            } else {
                // Incorrect
                errors++;
                totalChars++;
                const charSpan = textToType.children[currentIndex];
                charSpan.classList.add('incorrect');
                setTimeout(() => charSpan.classList.remove('incorrect'), 300);
                
                messageEl.textContent = `âŒ ×˜×¢×•×ª! ×œ×—×¥ ×¢×œ: ${expectedChar}`;
                messageEl.className = 'message error';
                setTimeout(() => {
                    messageEl.textContent = '';
                    messageEl.className = 'message';
                }, 1000);
            }

            typingInput.value = '';
            updateStats();
        }

        // Keyboard visualization
        document.addEventListener('keydown', (e) => {
            if (!isActive) return;
            
            const key = document.querySelector(`.key[data-key="${e.key}"]`);
            if (key) {
                key.classList.add('pressed');
            }
        });

        document.addEventListener('keyup', (e) => {
            const key = document.querySelector(`.key[data-key="${e.key}"]`);
            if (key) {
                setTimeout(() => key.classList.remove('pressed'), 100);
            }
        });

        typingInput.addEventListener('input', handleInput);

        startBtn.addEventListener('click', startNewExercise);

        resetBtn.addEventListener('click', () => {
            errors = 0;
            totalChars = 0;
            startTime = null;
            updateStats();
            startNewExercise();
        });

        // Initialize
        startNewExercise();
        
        // Update placeholder based on language
        function updatePlaceholder() {
            const lang = localStorage.getItem('hebrewGameLang') || 'he';
            const translations = {
                he: '×”×ª×—×œ ×œ×”×§×œ×™×“ ×›××Ÿ...',
                en: 'Start typing here...',
                fr: 'Commencez Ã  taper ici...'
            };
            const input = document.getElementById('typingInput');
            if (input) {
                input.placeholder = translations[lang] || translations['he'];
            }
        }
        
        // Update title based on language
        function updateTitle() {
            const lang = localStorage.getItem('hebrewGameLang') || 'he';
            const titles = {
                he: '×”×§×œ×“×” ×¢×™×•×•×¨×ª - ××××Ÿ ×”×§×œ×“×”',
                en: 'Touch Typing Trainer',
                fr: 'EntraÃ®neur de frappe au toucher'
            };
            document.title = titles[lang] || titles['he'];
        }
        
        // Wait for localization.js to load, then update placeholder and title
        function initializeLocalization() {
            updatePlaceholder();
            updateTitle();
            
            // Override setLanguage to update placeholder and title
            if (window.setLanguage) {
                const originalSetLanguage = window.setLanguage;
                window.setLanguage = function(lang) {
                    originalSetLanguage(lang);
                    updatePlaceholder();
                    updateTitle();
                };
            }
        }
        
        // Initialize after DOM and localization are ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(initializeLocalization, 100);
            });
        } else {
            setTimeout(initializeLocalization, 100);
        }
    </script>
</body>
</html>

